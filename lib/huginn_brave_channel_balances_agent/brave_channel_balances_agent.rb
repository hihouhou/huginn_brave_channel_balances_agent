module Agents
  class BraveChannelBalancesAgent < Agent
    include FormConfigurable

    can_dry_run!
    no_bulk_receive!
    default_schedule '12h'

    description do
      <<-MD
      The Brave Channel Balances Agent agent fetches the channels' balance from brave server and creates event.

      `changes_only` is only used to emit event about a card's change.

      `csrf_token` / `publishers_session` / `pk_id` are needed for the cooki.

      `debug` is used to verbose mode.

      `expected_receive_period_in_days` is used to determine if the Agent is working. Set it to the maximum number of days
      that you anticipate passing without this Agent receiving an incoming Event.
      MD
    end

    event_description <<-MD
      Events look like this:

          {
            "rates": {
              "AED": "1.001745355423197103",
              "AFN": "24.026410138774130526",
              "ALL": "31.862970265610952322",
              "AMD": "107.960784419764612827",
              "ANG": "0.49133153794923911",
              "AOA": "134.66255049375383893",
              "ARS": "43.726367017760541369",
              "AUD": "0.41238418720586973",
              "AWG": "0.491600452260434",
              "AZN": "0.463645364129119445",
              "BAM": "0.536179954021448834",
              "BBD": "0.545465134269552288",
              "BDT": "27.799351017166419217",
              "BGN": "0.523099972834232105",
              "BHD": "0.102838723624375771",
              "BIF": "562.286953095007554604",
              "BMD": "0.272732567134776144",
              "BND": "0.382676246865579968",
              "BOB": "1.88382111503899713",
              "BRL": "1.457864391629665266",
              "BSD": "0.272732567134776144",
              "BTC": "0.000015309862292855",
              "BTN": "22.290597169663236523",
              "BWP": "3.61556300512027033",
              "BYN": "0.688373181192235101",
              "BZD": "0.549533485973501744",
              "CAD": "0.363696514786103762",
              "CDF": "558.784584469085767495",
              "CHF": "0.263239019205381721",
              "CLF": "0.008840898896240903",
              "CLP": "244.104268389339212062",
              "CNH": "1.951171058830094425",
              "CNY": "1.960128959997636147",
              "COP": "1302.522892434112738847",
              "CRC": "167.689471899963426524",
              "CUC": "0.272732567134776144",
              "CUP": "7.022863603720485709",
              "CVE": "30.082402154965808689",
              "CZK": "6.498177691008364881",
              "DJF": "48.481141046849517157",
              "DKK": "1.989814263534853722",
              "DOP": "14.819914599951895294",
              "DZD": "37.964627531913408863",
              "EGP": "6.652683690348454049",
              "ERN": "4.090988507021642161",
              "ETB": "14.504598115249829472",
              "EUR": "0.267452191902479743",
              "FJD": "0.613307360344327854",
              "FKP": "0.233061978849620145",
              "GBP": "0.233061978849620145",
              "GEL": "0.73910525693524335",
              "GGP": "0.233061978849620145",
              "GHS": "3.945485136990104818",
              "GIP": "0.233061978849620145",
              "GMD": "16.711688051183408227",
              "GNF": "2358.792789675924126163",
              "GTQ": "2.131899476302490915",
              "GYD": "57.036892316767102353",
              "HKD": "2.139616989754703675",
              "HNL": "6.767352734537435005",
              "HRK": "2.018384636337624332",
              "HTG": "36.804081184682884137",
              "HUF": "107.397254843910888641",
              "IDR": "4232.673075648158367554",
              "ILS": "0.948904784203669899",
              "IMP": "0.233061978849620145",
              "INR": "21.950362473964901879",
              "IQD": "398.008388954577268009",
              "IRR": "11536.587589801030893233",
              "ISK": "39.611678050654887162",
              "JEP": "0.233061978849620145",
              "JMD": "41.879403800041839292",
              "JOD": "0.193367390098556286",
              "JPY": "38.628463509505662423",
              "KES": "33.218971770741450046",
              "KGS": "22.929505936084505814",
              "KHR": "1129.785592361615781086",
              "KMF": "132.916198865516290041",
              "KPW": "245.459310421298529643",
              "KRW": "368.126237141506795952",
              "KWD": "0.083942720443009941",
              "KYD": "0.227179955574224428",
              "KZT": "127.355760560145664459",
              "LAK": "4683.324431259001277423",
              "LBP": "409.231623461427036334",
              "LKR": "100.45800722701798541",
              "LRD": "41.946263097944661124",
              "LSL": "4.821953242293046713",
              "LYD": "1.35584195657872388",
              "MAD": "2.964796099412548107",
              "MDL": "5.248918258003075844",
              "MGA": "1172.004232928892808876",
              "MKD": "16.880698241176291925",
              "MMK": "572.491874833910956714",
              "MNT": "929.190382862462896322",
              "MOP": "2.203808417685813128",
              "MRU": "10.354330093831175177",
              "MUR": "11.945685622305493705",
              "MVR": "4.20280885954690038",
              "MWK": "279.609676454503328421",
              "MXN": "5.268374999342470775",
              "MYR": "1.281979431817015265",
              "MZN": "17.413974684288023932",
              "NAD": "4.79054754172234297",
              "NGN": "120.125226379575806264",
              "NIO": "9.816902933780219012",
              "NOK": "2.753754820765956923",
              "NPR": "35.664911070599248895",
              "NZD": "0.453042067384053618",
              "OMR": "0.105005038405127298",
              "PAB": "0.272732567134776144",
              "PEN": "1.062731902957905801",
              "PGK": "0.960357097430226284",
              "PHP": "15.604665197520516184",
              "PKR": "60.393332382585189004",
              "PLN": "1.25335505796595197",
              "PYG": "1953.901618836955837573",
              "QAR": "0.99301927693771994",
              "RON": "1.304970787226476894",
              "RSD": "31.375605077385554261",
              "RUB": "16.568503726170217886",
              "RWF": "289.528812918341451136",
              "SAR": "1.025335358817519566",
              "SBD": "2.244750485198951453",
              "SCR": "3.700589292052506736",
              "SDG": "155.048464416120237891",
              "SEK": "2.891189670531379048",
              "SGD": "0.377213959011004672",
              "SHP": "0.233061978849620145",
              "SLL": "4817.820798435820584609",
              "SOS": "154.946390980079242302",
              "SRD": "8.13820343701815275",
              "SSP": "35.526144194975940524",
              "STD": "6224.845522415673199919",
              "STN": "6.668311266445276722",
              "SVC": "2.385378487860387537",
              "SYP": "685.248756903139105205",
              "SZL": "4.827839083824382317",
              "THB": "9.870600703458250817",
              "TJS": "2.75346572424479406",
              "TMT": "0.957291310643064266",
              "TND": "0.868925958891396795",
              "TOP": "0.65748321790598322",
              "TRY": "5.047611622875226225",
              "TTD": "1.851087752331481297",
              "TWD": "8.571575486195312043",
              "TZS": "635.85247563662977057",
              "UAH": "10.068539091381985952",
              "UGX": "1030.497931308430607178",
              "USD": "0.272732567134776144",
              "UYU": "10.941626403782725161",
              "UZS": "3053.627010565500849288",
              "VES": "2.456884057776917416",
              "VND": "6781.861776829866295455",
              "VUV": "33.343950924165826944",
              "WST": "0.761975246352330004",
              "XAF": "175.437209847998630099",
              "XAG": "0.012585746138357773",
              "XAU": "0.000155544837688306",
              "XCD": "0.737073399310089268",
              "XDR": "0.202910575355169238",
              "XOF": "175.437209847998630099",
              "XPD": "0.000138338140027773",
              "XPF": "31.915549286298597276",
              "XPT": "0.000263317838917284",
              "YER": "68.25132274361719297",
              "ZAR": "4.742819342473757145",
              "ZMW": "4.457376074047664759",
              "ZWL": "87.819886617397918383",
              "$ADS": "2.287870690775537731",
              "1INCH": "0.475045799382751791",
              "AAPL": "0.001883375580934135",
              "AAVE": "0.003971707292823922",
              "ACH": "25.256253365444922565",
              "ADA": "0.729348763110022885",
              "ADBE": "0.000829741300428609",
              "AERGO": "2.456307540621963996",
              "AGLD": "1.058690550011036833",
              "AIOZ": "6.749220636576991442",
              "ALCX": "0.014924375996009642",
              "ALGO": "0.847580705762259813",
              "ALICE": "0.212425319148507893",
              "ALPHA": "2.764209776627099043",
              "AMP": "67.943449039429255733",
              "AMZN": "0.002848566021902298",
              "ANKR": "11.68176035920909618",
              "ANT": "0.148125538578922058",
              "APE": "0.076621703407232565",
              "API3": "0.166809086771620736",
              "APT": "0.052631946801908166",
              "AR": "0.025523032384270354",
              "ASM": "20.19603284351745883",
              "ASTR": "6.56024161148530203",
              "ATOM": "0.022220874855144184",
              "AUDIO": "1.626944218052006057",
              "AVAX": "0.01753434775240809",
              "AXS": "0.037078625894746481",
              "AZERO": "0.301070914247114483",
              "BA": "0.001525632362501529",
              "BABA": "0.003902251633617312",
              "BAC": "0.007148322597417903",
              "BADGER": "0.094384727003069145",
              "BAL": "0.049041924738235802",
              "BAND": "0.113689309666519449",
              "BAT": "1",
              "BCH": "0.002608105129773011",
              "BICO": "0.873131731163710082",
              "BIT": "0.797884114440681471",
              "BLZ": "4.38415635829876829",
              "BMY": "0.003432101664065586",
              "BNT": "0.680972962411680332",
              "BOBA": "1.133705314212267364",
              "BRK.B": "0.000899022262231351",
              "BTC0": "0.00001534735681982",
              "BTG": "0.017410407193198996",
              "BUSD": "0.268235851185118512",
              "C": "0.005604767553224536",
              "C98": "1.233978556640584833",
              "CAKE": "0.062703973788677171",
              "CELO": "0.52009650464899257",
              "CELR": "21.470137780651964819",
              "CHR": "2.267681640378987057",
              "CKB": "95.38294094045836753",
              "CLV": "4.289753444115435446",
              "CMCSA": "0.008254459734941969",
              "COMP": "0.006606682004007548",
              "COTI": "3.098645074894618882",
              "COVAL": "29.5061757196439994",
              "CQT": "3.835006714789233474",
              "CRO": "2.836764764130383351",
              "CRV": "0.389699747532057466",
              "CSCO": "0.005997348188009866",
              "CSPR": "7.383149382659831917",
              "CTSI": "2.312992860509993982",
              "CTX": "0.12124415464615569",
              "CVC": "2.78356008199174543",
              "CVX": "0.064726464231864486",
              "DAG": "4.821714038418555765",
              "DAI": "0.269300449566133469",
              "DASH": "0.007306029345951854",
              "DCR": "0.012679911398588302",
              "DGB": "36.149284078226574199",
              "DHR": "0.001020997479134723",
              "DIA": "0.863984128399718398",
              "DIS": "0.003024992864522252",
              "DNT": "11.491204040736892315",
              "DOGE": "3.011388779967998099",
              "DOT": "0.045488711833938708",
              "DYDX": "0.154528509273951919",
              "EEM": "0.007339813880537274",
              "EFA": "0.004267855117909148",
              "EGLD": "0.00567375069590554",
              "ENJ": "0.723304259595974206",
              "ENS": "0.020607562988109132",
              "EOS": "0.286551630505479781",
              "ETH": "0.000206643663366752",
              "EWZ": "0.009400493872075309",
              "EXFI": "0.848067580548207638",
              "FARM": "0.008909786231556424",
              "FB": "0.002441010951067289",
              "FET": "3.926081660461287738",
              "FIL": "0.057948582994280496",
              "FLOW": "0.198783979462481141",
              "FORTH": "0.086492997695589482",
              "FOX": "8.934828635288506966",
              "FRAX": "0.269533230534561575",
              "FTM": "1.300660374740714419",
              "FX": "1.422410012632659989",
              "FXI": "0.011212891219433667",
              "FXS": "0.050540206979450137",
              "GALA": "8.569984710441290757",
              "GDX": "0.009694840937712228",
              "GFI": "0.377768538785536563",
              "GHST": "0.254615394489523025",
              "GLD": "0.001659284427640077",
              "GLM": "1.281485004560055334",
              "GLMR": "0.674003417016465409",
              "GMT": "0.643703818837066497",
              "GNO": "0.002788425115583851",
              "GODS": "1.105865164871726635",
              "GOOG": "0.00289751631090399",
              "GOOGL": "0.002903089550820645",
              "GRT": "3.919012008887885637",
              "GTC": "0.149940934442597977",
              "GUSD": "0.268156787091389329",
              "HBAR": "5.388530166677761134",
              "HD": "0.000882466665777156",
              "HFT": "0.415284370148157425",
              "HIGH": "0.246745155634294716",
              "HNT": "0.088167463224507465",
              "HOP": "4.239770951949955125",
              "HYG": "0.003654505276082104",
              "ICX": "1.600173115004972084",
              "ILV": "0.005455957881841488",
              "IMX": "0.544428503993508487",
              "INJ": "0.151657766784867963",
              "INTC": "0.009241390704444668",
              "INV": "0.005010126656916872",
              "IOTA": "1.148019514397601587",
              "IVV": "0.000687016885605446",
              "IWM": "0.001465336264067479",
              "JNJ": "0.001554549655711226",
              "JOE": "1.625179944522308229",
              "JPM": "0.002009132071349714",
              "KAVA": "0.25818080134179081",
              "KDA": "0.254065388398624718",
              "KNC": "0.423495117917680399",
              "KP3R": "0.003363477129212192",
              "KRL": "0.914776380546067469",
              "KSM": "0.009565961815693187",
              "LDO": "0.224492440517637964",
              "LINK": "0.037315921721885016",
              "LOOM": "6.125678396333103225",
              "LPT": "0.033479790953324253",
              "LQD": "0.002601789853549056",
              "LQTY": "0.441156369637262794",
              "LRC": "0.994570132444471203",
              "LSK": "0.344606683841916122",
              "LTC": "0.004454661565253934",
              "LTX": "0.79636121990248176",
              "LUNA2": "0.148711253881835089",
              "LUNC": "1420.419129906681616437",
              "LUSD": "0.25827245376250185",
              "MA": "0.000805109716487252",
              "MANA": "0.505990988701537949",
              "MASK": "0.083007088314726336",
              "MATIC": "0.240627003578250455",
              "MCO2": "0.144733594193973114",
              "MDT": "11.581080459007280485",
              "MIM": "0.27072880249420773",
              "MINA": "0.446740252496767219",
              "MKR": "0.000307436165236113",
              "MLN": "0.013536403614543144",
              "MOVR": "0.029637272744703733",
              "MSFT": "0.00112136830374103",
              "MU": "0.004544810678278216",
              "MV": "1.434733951556858693",
              "MYTH": "0.260768368429948055",
              "NANO": "0.411407518285813246",
              "NEAR": "0.116216411672773159",
              "NEO": "0.037805825605144894",
              "NFLX": "0.000995428683272942",
              "NMR": "0.022430459674734006",
              "NU": "2.555904730388443361",
              "NUM": "6.183997832067552087",
              "NVDA": "0.001746851383404531",
              "OCEAN": "1.839414541053640851",
              "OMG": "0.203776389861934513",
              "ONE": "17.078760088347324338",
              "ONT": "1.463407806896410434",
              "OP": "0.258335378320847555",
              "ORCA": "0.480136670352372683",
              "ORN": "0.275420611928487132",
              "OXT": "3.087392186730908232",
              "PERP": "0.700629059290370098",
              "PG": "0.001922584404944968",
              "PICKLE": "0.251205207456356253",
              "PLA": "1.286930765531538067",
              "PNT": "1.556570743675496831",
              "POLS": "0.739571234122305075",
              "POWR": "1.817280535768631695",
              "PRQ": "2.832041228976333662",
              "QNT": "0.002145668285371436",
              "QQQ": "0.000967417330736003",
              "QRDO": "1.640477933305183141",
              "QSP": "18.489377028166239053",
              "QTUM": "0.115998616902402485",
              "RAD": "0.163155984417077426",
              "RAI": "0.095374500204278849",
              "RARE": "2.314357899260219947",
              "RARI": "0.08983251821477233",
              "RAY": "0.985133130173176333",
              "RBN": "1.253923651242927515",
              "REN": "2.880037672975071254",
              "REQ": "3.079750344503034257",
              "RLY": "23.206744078540399959",
              "RNDR": "0.445037950810655222",
              "ROKU": "0.004954050284651589",
              "ROOK": "0.023493447077167633",
              "ROSE": "5.11568547523282471",
              "RPL": "0.018012570379456074",
              "RSR": "59.221904159927144936",
              "RUNE": "0.220135598248562164",
              "RVN": "11.296481587051530877",
              "SAND": "0.404132179896221644",
              "SD": "0.638498691851987858",
              "SGB": "17.873199237494476121",
              "SHIB": "26425.302400459684683969",
              "SHPING": "52.885281567181469085",
              "SKL": "9.377243849626628339",
              "SNT": "11.837640964146846104",
              "SNX": "0.138714125778181445",
              "SOL": "0.015327874892961051",
              "SOLO": "1.175734671076797462",
              "SPELL": "381.057812708006590572",
              "SPY": "0.000689008796003956",
              "SRM": "0.679200122647562024",
              "STORJ": "0.806417672922682883",
              "STORM": "54.846614519557374499",
              "STX": "1.096450117555670856",
              "SUKU": "4.240238019662510769",
              "SUPER": "2.428668080589872073",
              "SUSHI": "0.217684368616900764",
              "SXP": "1.11941353893626247",
              "SYN": "0.413772997496059541",
              "T": "0.014440981481820022",
              "TFUEL": "5.62201535113196496",
              "THETA": "0.269627456436522667",
              "TLT": "0.00276736675520502",
              "TQQQ": "0.012823886491291179",
              "TRAC": "1.528920443072524144",
              "TRB": "0.023356400106880817",
              "TRIBE": "1.215781667148493463",
              "TRU": "9.894667417499817027",
              "TRX": "4.648249591814841778",
              "TSLA": "0.001470272055682339",
              "TUSD": "0.268235851185118512",
              "UMA": "0.14922703145570148",
              "UNFI": "0.064800999494259212",
              "UNH": "0.000499897108101066",
              "UNI": "0.046772382500753927",
              "UPBTC": "0.000015309862292855",
              "UPCO2": "0.029346013401429625",
              "UPEUR": "0.263130863641672695",
              "UPT": "788.279042564166017381",
              "UPUSD": "0.268881230676691729",
              "UPXAU": "0.000154492948169994",
              "USDC": "0.268235851185118512",
              "USDP": "0.268235851185118512",
              "USDT": "0.269803530934699047",
              "V": "0.001325413073726563",
              "VCO": "67.052927429274292743",
              "VET": "12.227609424895526755",
              "VOX": "26820.902759999999999965",
              "WBTC": "0.000015326933800839",
              "WCFG": "1.130173031905149818",
              "WFC": "0.005661088047242617",
              "XCH": "0.008478773338599475",
              "XCN": "6.128243995412416608",
              "XDC": "9.837604501131363464",
              "XEM": "7.905092135389816962",
              "XLF": "0.00762550647397178",
              "XLM": "2.770278656338443166",
              "XLU": "0.003959278867756986",
              "XOM": "0.002477521453463585",
              "XRP": "0.680759799292054401",
              "XTZ": "0.235406908528101029",
              "XYO": "52.233564591182020776",
              "YFI": "0.000040283431553924",
              "YFII": "0.000148741228229235",
              "YGG": "1.097531195351399978",
              "ZIL": "11.293047826174096389",
              "ZRX": "1.3874712417659619",
              "BCC": "0.002608105129773011"
            },
            "default_currency": "BAT",
            "amount_probi": XXXXXXXXXXXXXXXXXXX,
            "fees_probi": XXXXXXXXXXXXXXXXXX,
            "amount_bat": "X.XXXXXXXXXXXXXXXXXX",
            "fees_bat": "X.XXXXXXXXXXXXXXXXXX",
            "amount_default_currency": "X.XXXXXXXXXXXXXXXXXX",
            "fees_default_currency": "X.XXXXXXXXXXXXXXXXXX",
            "channel": "XXXXXXXX.com"
          }
    MD

    def default_options
      {
        'csrf_token' => '',
        'publishers_session' => '',
        'pk_id' => '',
        'expected_receive_period_in_days' => '31',
        'changes_only' => 'true',
        'debug' => 'false'
      }
    end

    form_configurable :expected_receive_period_in_days, type: :string
    form_configurable :csrf_token, type: :string
    form_configurable :publishers_session, type: :string
    form_configurable :pk_id, type: :string
    form_configurable :changes_only, type: :boolean
    form_configurable :debug, type: :boolean

    def validate_options
      unless options['csrf_token'].present?
        errors.add(:base, "csrf_token is a required field")
      end

      unless options['publishers_session'].present?
        errors.add(:base, "publishers_session is a required field")
      end

      unless options['pk_id'].present?
        errors.add(:base, "pk_id is a required field")
      end

      if options.has_key?('changes_only') && boolify(options['changes_only']).nil?
        errors.add(:base, "if provided, changes_only must be true or false")
      end

      if options.has_key?('debug') && boolify(options['debug']).nil?
        errors.add(:base, "if provided, debug must be true or false")
      end

      unless options['expected_receive_period_in_days'].present? && options['expected_receive_period_in_days'].to_i > 0
        errors.add(:base, "Please provide 'expected_receive_period_in_days' to indicate how many days can pass before this Agent is considered to be not working")
      end
    end

    def working?
      event_created_within?(options['expected_receive_period_in_days']) && !recent_error_logs?
    end

    def check
      fetch
    end

    private

    def fetch
      uri = URI.parse("https://publishers.basicattentiontoken.org/publishers/wallet")
      request = Net::HTTP::Get.new(uri)
      request["Authority"] = "publishers.basicattentiontoken.org"
      request["Accept"] = "application/json"
      request["X-Csrf-Token"] = "#{interpolated['csrf_token']}"
      request["User-Agent"] = "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.106 Safari/537.36"
      request["X-Requested-With"] = "XMLHttpRequest"
      request["Sec-Gpc"] = "1"
      request["Sec-Fetch-Site"] = "same-origin"
      request["Sec-Fetch-Mode"] = "cors"
      request["Sec-Fetch-Dest"] = "empty"
      request["Referer"] = "https://publishers.basicattentiontoken.org/publishers/statements?locale=en"
      request["Accept-Language"] = "fr,en-US;q=0.9,en;q=0.8"
      request["Cookie"] = "_pk_testcookie..undefined=1; _pk_id.6.8f93=#{interpolated['pk_id']}; _pk_ses.6.8f93=1; _publishers_session=#{interpolated['publishers_session']}"
      
      req_options = {
        use_ssl: uri.scheme == "https",
      }
  
      response = Net::HTTP.start(uri.hostname, uri.port, req_options) do |http|
        http.request(request)
      end
      
      log "request  status : #{response.code}"

      payload = JSON.parse(response.body)
      output = payload.dup

      if interpolated['debug'] == 'true'
        log payload
      end

      if interpolated['changes_only'] == 'true'
        if payload.to_s != memory['last_status']
          if "#{memory['last_status']}" == ''
            output['wallet']['channel_balances'].each do |channel, v|
              v['channel'] = channel
              create_event payload: v
            end
          else
            last_status = memory['last_status'].gsub("=>", ": ").gsub(": nil", ": null")
            last_status = JSON.parse(last_status)
            output['wallet']['channel_balances'].each do |channel, v|
              found = false
              if interpolated['debug'] == 'true'
                log "v"
                log v
              end
              last_status['wallet']['channel_balances'].each do |channelbis, vbis|
                if channel == channelbis && v['amount_bat'] == vbis['amount_bat']
                  found = true
                end
                if interpolated['debug'] == 'true'
                  log "vbis"
                  log vbis
                  log "found is #{found}!"
                end
              end
              if found == false
                if interpolated['debug'] == 'true'
                  log "found is #{found}! so event created"
                  log v
                end
                v['channel'] = channel
                create_event payload: v
              end
            end
          end
          memory['last_status'] = payload.to_s
        end
      else
        create_event payload: payload
        if payload.to_s != memory['last_status']
          memory['last_status'] = payload.to_s
        end
      end
    end
  end
end
